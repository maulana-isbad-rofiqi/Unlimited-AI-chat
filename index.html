<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unlimited AI - Vercel</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
    <script>tailwind.config = { theme: { extend: { colors: { primary: '#6366f1', secondary: '#8b5cf6', darker: '#020617', surface: '#1e293b' } } } }</script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const unlimitedai = async (question) => {
            try {
                if (!question) throw new Error('Pertanyaan kosong.');
                
                // OTOMATIS MENGGUNAKAN BACKEND SENDIRI (Relative URL)
                // Karena frontend & backend di domain sama (Vercel), kita cukup panggil /api
                const BACKEND_URL = "/api"; 

                const { data: tokenData } = await axios.get(`${BACKEND_URL}/token`);
                if (!tokenData || !tokenData.token) throw new Error("Gagal auth.");

                const chatUuid = crypto.randomUUID();
                const msgUuid = crypto.randomUUID();

                const { data } = await axios.post(`${BACKEND_URL}/chat`, {
                    messages: [{
                        id: msgUuid, createdAt: new Date().toISOString(), role: 'user', content: question,
                        parts: [{ type: 'text', text: question }]
                    }],
                    id: chatUuid, selectedChatModel: 'chat-model-reasoning', selectedCharacter: null, selectedStory: null
                }, { headers: { 'x-api-token': tokenData.token } });
                
                if (typeof data === 'string') {
                    const resultLine = data.split('\n').find(line => line.startsWith('0:'));
                    if (resultLine) {
                        let cleanText = resultLine.slice(2); 
                        if (cleanText.startsWith('"') && cleanText.endsWith('"')) cleanText = cleanText.slice(1, -1);
                        try { return JSON.parse(`"${cleanText}"`); } catch (e) { return cleanText; }
                    }
                } 
                return typeof data === 'object' ? JSON.stringify(data) : data;
            } catch (error) {
                throw new Error("Backend Error: " + (error.response?.data?.error || error.message));
            }
        };

        const App = () => {
            const [input, setInput] = useState('');
            const [messages, setMessages] = useState([{ role: 'assistant', content: 'Halo! Sistem Backend Vercel Siap.' }]);
            const [isLoading, setIsLoading] = useState(false);
            const messagesEndRef = useRef(null);

            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages]);

            const handleSend = async () => {
                if (!input.trim() || isLoading) return;
                const q = input; setInput('');
                setMessages(p => [...p, { role: 'user', content: q }]);
                setIsLoading(true);
                try {
                    const res = await unlimitedai(q);
                    setMessages(p => [...p, { role: 'assistant', content: res }]);
                } catch (e) {
                    setMessages(p => [...p, { role: 'assistant', content: `Error: ${e.message}`, isError: true }]);
                } finally { setIsLoading(false); }
            };

            return (
                <div className="flex flex-col h-screen bg-darker text-gray-200">
                    <div className="glass fixed top-0 w-full h-16 z-50 flex items-center px-6">
                        <h1 className="font-bold text-xl text-white">Unlimited AI <span className="text-xs font-normal text-primary bg-primary/10 px-2 py-1 rounded ml-2">Vercel Edition</span></h1>
                    </div>
                    <div className="flex-1 overflow-y-auto pt-20 pb-24 px-4">
                        <div className="max-w-3xl mx-auto">
                            {messages.map((m, i) => (
                                <div key={i} className={`flex mb-4 ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`p-4 rounded-xl max-w-[85%] ${m.role === 'user' ? 'bg-surface border border-gray-700' : m.isError ? 'bg-red-900/30 border border-red-500' : 'bg-gradient-to-r from-slate-800 to-slate-900 border border-slate-700'}`}>
                                        {m.content}
                                    </div>
                                </div>
                            ))}
                            {isLoading && <div className="text-xs text-gray-500 animate-pulse">Sedang berpikir...</div>}
                            <div ref={messagesEndRef} />
                        </div>
                    </div>
                    <div className="fixed bottom-0 w-full bg-darker p-4 border-t border-gray-800">
                        <div className="max-w-3xl mx-auto flex gap-2">
                            <input value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleSend()} className="flex-1 bg-surface border border-gray-700 rounded-xl px-4 py-3 focus:outline-none focus:border-primary" placeholder="Ketik pesan..." />
                            <button onClick={handleSend} disabled={isLoading} className="bg-primary text-white p-3 rounded-xl"><i className="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
